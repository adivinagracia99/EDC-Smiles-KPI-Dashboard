<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Verification Dashboard</title>

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>

<body class="bg-slate-950">
<div id="root"></div>

<script type="text/babel">
const { useEffect, useState, useRef } = React;

const SHEET_ID = '1bwbHVmOhorOGxLu_xAuOoiEksaSEn3d4trZB1x7NKXc';
const API_KEY  = 'AIzaSyAeiFMlkhhDjEahdKksbS6HomSCbO9iQ50';
const RANGE    = 'Data!A:W';

/* ---------------- Utils ---------------- */

const parseDate = (val) => {
  if (!val) return null;
  if (val.includes('/')) {
    const [m, d, y] = val.split('/');
    return new Date(y, m - 1, d);
  }
  if (val.includes('-')) {
    const [y, m, d] = val.split('-');
    return new Date(y, m - 1, d);
  }
  return null;
};

/* ---------------- Chart ---------------- */

const AccuracyChart = ({ data }) => {
  const ref = useRef(null);
  const chart = useRef(null);

  useEffect(() => {
    if (!ref.current || !data.length) return;
    if (chart.current) chart.current.destroy();

    chart.current = new Chart(ref.current, {
      type: 'line',
      data: {
        labels: data.map(d => d.label),
        datasets: [{
          data: data.map(d => d.value),
          borderColor: '#22d3ee',
          backgroundColor: 'rgba(34,211,238,0.15)',
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: { min: 0, max: 100, ticks: { callback: v => v + '%' } }
        }
      }
    });

    return () => chart.current && chart.current.destroy();
  }, [data]);

  return <canvas ref={ref} className="h-72"></canvas>;
};

/* ---------------- App ---------------- */

const App = () => {
  const [rows, setRows] = useState([]);
  const [startDate, setStartDate] = useState('');
  const [endDate, setEndDate] = useState('');
  const [error, setError] = useState('');

  /* Fetch data */
  useEffect(() => {
    fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`)
      .then(res => res.json())
      .then(json => {
        const data = json.values.slice(1).map(r => ({
          date: r[0],
          status: r[9],
          mistakes: [r[16], r[17], r[18], r[19], r[20], r[21], r[22]]
        }));
        setRows(data);

        const dates = data.map(d => parseDate(d.date)).filter(Boolean);
        if (dates.length) {
          setStartDate(dates[0].toISOString().slice(0,10));
          setEndDate(dates[dates.length - 1].toISOString().slice(0,10));
        }
      })
      .catch(() => setError('Failed to fetch data'));
  }, []);

  /* Filter */
  const filtered = rows.filter(r => {
    const d = parseDate(r.date);
    if (!d) return false;
    if (startDate && d < new Date(startDate)) return false;
    if (endDate && d > new Date(endDate)) return false;
    return r.status && r.status.toLowerCase() !== 'verifying';
  });

  /* Metrics */
  const totalVerifications = filtered.length;

  const totalMistakes = filtered.reduce((sum, r) => {
    return sum + r.mistakes.filter(m => m && m.trim()).length;
  }, 0);

  const accuracy = Math.max(0, 100 - totalMistakes * 2);

  /* Chart data (daily) */
  const chartData = {};
  filtered.forEach(r => {
    const d = parseDate(r.date);
    const key = `${d.getMonth()+1}/${d.getDate()}`;
    chartData[key] ??= { v: 0, m: 0 };
    chartData[key].v++;
    chartData[key].m += r.mistakes.filter(m => m && m.trim()).length;
  });

  const performance = Object.entries(chartData).map(([k,v]) => ({
    label: k,
    value: Math.max(0, 100 - v.m * 2)
  }));

  /* Status breakdown */
  const statusBreakdown = {};
  filtered.forEach(r => {
    statusBreakdown[r.status] = (statusBreakdown[r.status] || 0) + 1;
  });

  return (
    <div className="p-8 max-w-6xl mx-auto text-white">
      <h1 className="text-3xl font-bold mb-6">Verification Dashboard</h1>

      {error && <div className="bg-red-800 p-3 rounded mb-4">{error}</div>}

      <div className="flex gap-4 mb-6">
        <input type="date" value={startDate} onChange={e=>setStartDate(e.target.value)} className="bg-slate-800 p-2 rounded"/>
        <input type="date" value={endDate} onChange={e=>setEndDate(e.target.value)} className="bg-slate-800 p-2 rounded"/>
      </div>

      <div className="grid grid-cols-2 gap-6 mb-8">
        <div className="bg-slate-800 p-6 rounded">
          <p className="text-sm text-slate-400">Total Verifications</p>
          <p className="text-4xl font-bold">{totalVerifications}</p>
          <p className="text-sm text-slate-400">{totalMistakes} mistakes</p>
        </div>

        <div className="bg-emerald-600 p-6 rounded">
          <p className="text-sm">Accuracy</p>
          <p className="text-5xl font-black">{accuracy}%</p>
          <p className="text-sm">-2% per mistake</p>
        </div>
      </div>

      <div className="bg-slate-800 p-6 rounded mb-8">
        <h2 className="font-bold mb-4">Accuracy Trend</h2>
        <AccuracyChart data={performance} />
      </div>

      <div className="bg-slate-800 p-6 rounded">
        <h2 className="font-bold mb-4">Verification Breakdown</h2>
        {Object.entries(statusBreakdown).map(([s,c]) => (
          <div key={s} className="flex justify-between border-b border-slate-700 py-2">
            <span>{s}</span>
            <span>{c}</span>
          </div>
        ))}
      </div>
    </div>
  );
};

ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>
